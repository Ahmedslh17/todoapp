<%# app/views/tasks/index.html.erb %>
<% total = Task.count %>
<% done  = Task.done.count %>
<% todo  = Task.todo.count %>
<% pct   = total.zero? ? 0 : ((done.to_f / total) * 100).round %>

<!-- âœ… En-tÃªte dâ€™intro -->
<section class="mb-6 text-center">
  <h2 class="text-2xl font-bold tracking-tight">Ma To-Do quotidienne ğŸ“</h2>
  <p class="mt-1 text-sm text-slate-500">
    Ajoute, coche et rÃ©organise facilement tes tÃ¢ches du jour.
  </p>
</section>

<!-- âœ… Carte de progression -->
<section class="mb-4 rounded-2xl border border-slate-100 p-4 bg-white shadow-sm">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm text-slate-500">Progression</p>
      <p class="text-xl font-semibold"><span id="progress-pct"><%= pct %></span>%</p>
    </div>
    <div class="text-sm text-slate-500">
      <span id="todo-count"><%= todo %></span> Ã  faire â€¢ <span id="done-count"><%= done %></span> faites
    </div>
  </div>
  <div class="mt-3 h-2 w-full rounded-full bg-slate-100">
    <div id="progress-bar" class="h-2 rounded-full bg-indigo-600 transition-all duration-300"
         style="width:<%= pct %>%"></div>
  </div>
</section>

<!-- âœ… Onglets filtres -->
<nav class="mb-3 grid grid-cols-3 gap-2 text-sm">
  <%= link_to "Toutes", tasks_path,
      class: "rounded-xl border border-slate-200 px-3 py-2 text-center hover:bg-slate-50 #{'bg-slate-100' unless %w[todo done].include?(params[:q])}" %>
  <%= link_to "Ã€ faire", tasks_path(q: 'todo'),
      class: "rounded-xl border border-slate-200 px-3 py-2 text-center hover:bg-slate-50 #{'bg-slate-100' if params[:q] == 'todo'}" %>
  <%= link_to "Faites", tasks_path(q: 'done'),
      class: "rounded-xl border border-slate-200 px-3 py-2 text-center hover:bg-slate-50 #{'bg-slate-100' if params[:q] == 'done'}" %>
</nav>

<!-- âœ… Formulaire dâ€™ajout -->
<%= render "form", task: Task.new %>

<!-- âœ… Liste des tÃ¢ches -->
<% if @tasks.none? %>
  <div class="mt-6 rounded-2xl border-2 border-dashed border-slate-200 p-8 text-center text-slate-500 bg-white">
    <svg width="40" height="40" viewBox="0 0 24 24" class="mx-auto mb-2 opacity-60" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"/>
      <rect x="3" y="4" width="18" height="16" rx="2" />
      <path d="M7 8h10M7 12h3" />
    </svg>
    Aucune tÃ¢che pour le moment. Ajoute-en une ci-dessus âœ¨
  </div>
<% else %>
  <div id="task-list" class="mt-3 grid gap-2">
    <% @tasks.each do |task| %>
      <div class="task-row group flex items-center justify-between rounded-2xl border border-slate-200 bg-white p-3 transition hover:shadow-sm"
           data-id="<%= task.id %>" draggable="true">

        <div class="flex items-center gap-3">
          <!-- poignÃ©e drag -->
          <span class="cursor-grab select-none opacity-60 group-hover:opacity-100 transition" title="Glisser pour rÃ©ordonner">â‹®â‹®</span>

          <%# DÃ©sactive Turbo pour gÃ©rer lâ€™animation/optimistic UI en JS %>
          <%= button_to task_path(task),
                method: :patch,
                params: { task: { done: !task.done } },
                form: { data: { turbo: false } },
                class: "toggle-form grid h-8 w-8 place-items-center rounded-xl border border-slate-200 hover:bg-slate-50 transition" do %>
            <%= task.done ? "â†©ï¸" : "âœ…" %>
          <% end %>

          <span class="task-title text-[15px] transition <%= 'line-through text-slate-400' if task.done %>">
            <%= task.title %>
          </span>
        </div>

        <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition">
          <button class="remind-btn rounded-xl border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50"
                  data-id="<%= task.id %>"
                  data-title="<%= task.title %>">ğŸ”” Rappel</button>

          <%= link_to "âœï¸", edit_task_path(task),
                class: "rounded-xl border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50" %>

          <%= button_to "ğŸ—‘ï¸", task_path(task), method: :delete,
                data: { confirm: "Supprimer cette tÃ¢che ?", turbo: false },
                class: "rounded-xl border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50" %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<!-- âœ… Dialogue de planification de rappel -->
<div id="reminder-dialog"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30 p-4">
  <div class="w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
    <h3 class="text-lg font-semibold mb-3">Programmer un rappel</h3>

    <form id="reminder-form" class="space-y-3">
      <div>
        <label class="text-sm text-slate-600">Titre</label>
        <input id="reminder-title" type="text"
               class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
               readonly />
      </div>

      <div>
        <label class="text-sm text-slate-600">Heure</label>
        <input id="reminder-time" type="time"
               class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
               required />
        <p class="mt-1 text-xs text-slate-500">Lâ€™alerte sonnera aujourdâ€™hui Ã  lâ€™heure choisie (ou demain si lâ€™heure est dÃ©jÃ  passÃ©e).</p>
      </div>

      <div class="flex items-center gap-2 pt-1">
        <button type="submit"
                class="rounded-xl bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">Enregistrer</button>
        <button type="button" id="reminder-cancel"
                class="rounded-xl border border-slate-300 px-4 py-2 hover:bg-slate-50">Annuler</button>
      </div>
      <input type="hidden" id="reminder-task-id" />
    </form>
  </div>
</div>
