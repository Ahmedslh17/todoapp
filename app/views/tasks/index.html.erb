<%# app/views/tasks/index.html.erb %>
<% total = Task.count %>
<% done  = Task.done.count %>
<% todo  = Task.todo.count %>
<% pct   = total.zero? ? 0 : ((done.to_f / total) * 100).round %>

<!-- En-tÃªte -->
<section class="mb-6 text-center">
  <h2 class="text-2xl font-bold tracking-tight"> Ma To-Do quotidienne âœ…</h2>
  <p class="mt-1 text-sm text-slate-500">
    Ajoute, coche et rÃ©organise facilement tes tÃ¢ches du jour.
  </p>
</section>

<!-- Carte progression -->
<section class="mb-4 rounded-2xl border border-slate-100 p-4 bg-white shadow-sm">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm text-slate-500">Progression</p>
      <p class="text-xl font-semibold"><span id="progress-pct"><%= pct %></span>%</p>
    </div>
    <div class="text-sm text-slate-500">
      <span id="todo-count"><%= todo %></span> Ã  faire â€¢
      <span id="done-count"><%= done %></span> faites
    </div>
  </div>
  <div class="mt-3 h-2 w-full rounded-full bg-slate-100">
    <div id="progress-bar"
         class="h-2 rounded-full bg-indigo-600 transition-all duration-300"
         style="width:<%= pct %>%"></div>
  </div>
</section>

<!-- Filtres -->
<nav class="mb-3 grid grid-cols-3 gap-2 text-sm">
  <%= link_to "Toutes", tasks_path,
      class: "rounded-xl border border-slate-200 px-3 py-2 text-center hover:bg-slate-50 #{'bg-slate-100' unless %w[todo done].include?(params[:q])}" %>

  <%= link_to "Ã€ faire", tasks_path(q: 'todo'),
      class: "rounded-xl border border-slate-200 px-3 py-2 text-center hover:bg-slate-50 #{'bg-slate-100' if params[:q] == 'todo'}" %>

  <%= link_to "Faites", tasks_path(q: 'done'),
      class: "rounded-xl border border-slate-200 px-3 py-2 text-center hover:bg-slate-50 #{'bg-slate-100' if params[:q] == 'done'}" %>
</nav>

<!-- Formulaire dâ€™ajout -->
<%= render "form", task: Task.new %>

<!-- Liste des tÃ¢ches -->
<% if @tasks.none? %>
  <div class="mt-6 rounded-2xl border-2 border-dashed border-slate-200 p-8 text-center text-slate-500 bg-white">
    Aucune tÃ¢che pour le moment. Ajoute-en une ci-dessus âœ¨
  </div>
<% else %>
  <div id="task-list" class="mt-3 space-y-2">
    <% @tasks.each do |task| %>
      <div class="task-row flex flex-wrap items-center justify-between gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 transition hover:shadow-sm"
           data-id="<%= task.id %>" draggable="true">

        <!-- Partie gauche -->
        <div class="flex items-center gap-3">
          <!-- PoignÃ©e drag -->
          <span class="cursor-grab select-none opacity-60 hover:opacity-100 transition">â‹®â‹®</span>

          <!-- Toggle done -->
          <%= button_to task_path(task),
                method: :patch,
                params: { task: { done: !task.done } },
                form: { data: { turbo: false } },
                class: "grid h-8 w-8 place-items-center rounded-xl border border-slate-200 hover:bg-slate-50 transition" do %>
            <%= task.done ? "â†©ï¸" : "âœ…" %>
          <% end %>

          <!-- Titre -->
          <%= link_to task_path(task),
                class: "text-[15px] transition hover:underline #{'line-through text-slate-400' if task.done}" do %>
            <%= task.title %>
          <% end %>
        </div>

        <!-- Partie droite : boutons colorÃ©s, wrap si manque de place -->
        <div class="flex flex-wrap items-center gap-2">

          <!-- ğŸ”” Rappel â€” fond jaune forcÃ© -->
          <button type="button"
                  class="remind-btn flex items-center gap-1 rounded-xl px-3 py-1.5 text-xs font-medium shadow-sm"
                  style="background-color:#facc15; color:white;"
                  data-id="<%= task.id %>"
                  data-title="<%= task.title %>">
            ğŸ”” <span>Rappel</span>
          </button>

          <!-- âœï¸ Modifier â€” fond bleu forcÃ© -->
          <%= link_to edit_task_path(task),
                class: "flex items-center gap-1 rounded-xl px-3 py-1.5 text-xs font-medium shadow-sm",
                style: "background-color:#3b82f6; color:white;" do %>
            âœï¸ <span>Modifier</span>
          <% end %>

          <!-- ğŸ—‘ï¸ Supprimer â€” fond rouge forcÃ© -->
          <%= button_to task_path(task), method: :delete,
                data: { confirm: 'Supprimer cette tÃ¢che ?', turbo: false },
                class: "flex items-center gap-1 rounded-xl px-3 py-1.5 text-xs font-medium shadow-sm",
                style: "background-color:#ef4444; color:white;" do %>
            ğŸ—‘ï¸ <span>Supprimer</span>
          <% end %>

        </div>
      </div>
    <% end %>
  </div>
<% end %>

<!-- Popup de rappel -->
<div id="reminder-dialog"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30 p-4">
  <div class="w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
    <h3 class="text-lg font-semibold mb-3">Programmer un rappel</h3>

    <form id="reminder-form" class="space-y-3">
      <div>
        <label class="text-sm text-slate-600">Titre</label>
        <input id="reminder-title" type="text"
               class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
               readonly />
      </div>

      <div>
        <label class="text-sm text-slate-600">Heure</label>
        <input id="reminder-time" type="time"
               class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
               required />
        <p class="mt-1 text-xs text-slate-500">
          Le rappel sera dÃ©clenchÃ© Ã  lâ€™heure choisie (ou demain si lâ€™heure est dÃ©jÃ  passÃ©e).
        </p>
      </div>

      <div class="flex items-center gap-2 pt-1">
        <button type="submit"
                class="rounded-xl bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
          Enregistrer
        </button>
        <button type="button" id="reminder-cancel"
                class="rounded-xl border border-slate-300 px-4 py-2 hover:bg-slate-50">
          Annuler
        </button>
      </div>

      <input type="hidden" id="reminder-task-id" />
    </form>
  </div>
</div>

<!-- JS rappels -->
<script>
  function setupReminderUI() {
    const dialog        = document.getElementById("reminder-dialog");
    const form          = document.getElementById("reminder-form");
    const titleInput    = document.getElementById("reminder-title");
    const timeInput     = document.getElementById("reminder-time");
    const taskIdInput   = document.getElementById("reminder-task-id");
    const cancelButton  = document.getElementById("reminder-cancel");
    const remindButtons = document.querySelectorAll(".remind-btn");

    if (!dialog || !form) return;

    // Ouvrir la modale
    remindButtons.forEach((btn) => {
      btn.addEventListener("click", (event) => {
        event.preventDefault();
        titleInput.value  = btn.dataset.title;
        taskIdInput.value = btn.dataset.id;
        timeInput.value   = "";
        dialog.classList.remove("hidden");
        dialog.classList.add("flex");
      });
    });

    // Fermer la modale
    cancelButton.addEventListener("click", () => {
      dialog.classList.add("hidden");
      dialog.classList.remove("flex");
    });

    function saveReminder(taskId, targetTime) {
      const token = document.querySelector('meta[name="csrf-token"]')?.content;

      fetch(`/tasks/${taskId}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRF-Token": token
        },
        body: JSON.stringify({
          task: { reminder_at: targetTime.toISOString() }
        })
      }).catch((e) => console.error("Erreur de sauvegarde du rappel :", e));
    }

    form.addEventListener("submit", (event) => {
      event.preventDefault();

      const timeValue = timeInput.value;
      if (!timeValue) {
        alert("Choisis une heure pour le rappel.");
        return;
      }

      const [hour, minute] = timeValue.split(":").map(Number);
      const now    = new Date();
      const target = new Date();
      target.setHours(hour, minute, 0, 0);
      if (target <= now) target.setDate(target.getDate() + 1);

      saveReminder(taskIdInput.value, target);

      dialog.classList.add("hidden");
      dialog.classList.remove("flex");
    });
  }

  document.addEventListener("turbo:load", setupReminderUI);
  document.addEventListener("DOMContentLoaded", setupReminderUI);
</script>
